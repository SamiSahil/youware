// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"] 
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Connection string stored in a .env file
}

// ENUMS for data consistency and integrity
enum Role {
  admin
  teacher
  student
  accountant
  clerk      
  librarian  
  staff      
}

enum AttendanceStatus {
  present
  absent
}

enum FeeStatus {
  pending
  paid
  partial
  overdue
}

enum NoticeAudience {
  Everyone
  Teachers
  Students
}

enum NoticePriority {
  High
  Medium
  Low
}

// MODELS (Tables in your database)

model User {
  id                String      @id @default(cuid())
  email             String      @unique
  name              String
  password          String // This will store the hashed password
  role              Role
  avatar            String?
  status            String      @default("active")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  classEnrollments  StudentClassEnrollment[] @relation("StudentToClass")
  taughtClasses     Class[]                  @relation("TeacherToClass")
  attendances       Attendance[]
  assignments       Assignment[]             @relation("TeacherAssignments")
  submissions       Submission[]
  invoices          Invoice[]
  authoredNotices   Notice[]

  @@map("users")
}

model Class {
  id              String      @id @default(cuid())
  name            String
  description     String?
  subject         String
  schedule        String?
  room            String?
  
  teacherId       String
  teacher         User        @relation("TeacherToClass", fields: [teacherId], references: [id])
  
  enrollments     StudentClassEnrollment[] @relation("ClassToStudent")
  exams           Exam[]
  attendances     Attendance[]
  assignments     Assignment[]

  @@map("classes")
}

// Join table for many-to-many relationship between Students and Classes
model StudentClassEnrollment {
  id          String   @id @default(cuid())
  studentId   String
  classId     String
  enrollDate  DateTime @default(now())

  student     User     @relation("StudentToClass", fields: [studentId], references: [id])
  class       Class    @relation("ClassToStudent", fields: [classId], references: [id])

  @@unique([studentId, classId])
  @@map("student_class_enrollments")
}

model Exam {
  id            String     @id @default(cuid())
  title         String
  description   String?
  duration      Int // in minutes
  totalMarks    Int
  scheduledDate DateTime
  status        String     @default("scheduled")
  
  classId       String
  class         Class      @relation(fields: [classId], references: [id])
  
  questions     Question[]
  results       ExamResult[]

  @@map("exams")
}

model Question {
  id            String   @id @default(cuid())
  questionText  String
  marks         Int
  
  examId        String
  exam          Exam     @relation(fields: [examId], references: [id])
  
  options       Option[]

  @@map("questions")
}

model Option {
  id            String   @id @default(cuid())
  optionText    String
  isCorrect     Boolean
  
  questionId    String
  question      Question @relation(fields: [questionId], references: [id])

  @@map("options")
}

model ExamResult {
  id            String   @id @default(cuid())
  score         Int
  totalMarks    Int
  timeTaken     Int // in seconds
  submittedAt   DateTime @default(now())
  
  examId        String
  studentId     String
  
  exam          Exam     @relation(fields: [examId], references: [id])
  // We can't link studentId directly to User because Prisma requires a direct relation field.
  // The user can be queried separately.

  @@map("exam_results")
}

model Attendance {
  id              String           @id @default(cuid())
  date            DateTime         @db.Date
  status          AttendanceStatus
  
  studentId       String
  classId         String
  markedById      String // Teacher who marked it
  
  student         User             @relation(fields: [studentId], references: [id])
  class           Class            @relation(fields: [classId], references: [id])
  
  @@unique([studentId, classId, date])
  @@map("attendances")
}

model Assignment {
  id              String      @id @default(cuid())
  title           String
  description     String?
  points          Int
  dueDate         DateTime
  
  classId         String
  teacherId       String
  
  class           Class       @relation(fields: [classId], references: [id])
  teacher         User        @relation("TeacherAssignments", fields: [teacherId], references: [id])
  submissions     Submission[]

  @@map("assignments")
}

model Submission {
  id              String     @id @default(cuid())
  content         String? // Path to file or text
  submissionDate  DateTime   @default(now())
  grade           Int?
  
  assignmentId    String
  studentId       String

  assignment      Assignment @relation(fields: [assignmentId], references: [id])
  student         User       @relation(fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@map("submissions")
}

model Invoice {
  id              String     @id @default(cuid())
  description     String
  amount          Float
  dueDate         DateTime
  status          FeeStatus  @default(pending)
  
  studentId       String
  student         User       @relation(fields: [studentId], references: [id])
  
  payments        Payment[]
  createdAt       DateTime   @default(now())

  @@map("invoices")
}

model Payment {
  id              String   @id @default(cuid())
  amountPaid      Float
  paymentDate     DateTime @default(now())
  paymentMethod   String   // e.g., 'Credit Card', 'Cash'
  transactionId   String?
  
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

model Notice {
  id          String         @id @default(cuid())
  title       String
  content     String
  authorId    String
  author      User           @relation(fields: [authorId], references: [id])
  audience    NoticeAudience @default(Everyone)
  priority    NoticePriority @default(Medium)
  isPinned    Boolean        @default(false)
  createdAt   DateTime       @default(now())

  @@map("notices")
}

model SystemSetting {
  key   String @id
  value Json

  @@map("system_settings")
}